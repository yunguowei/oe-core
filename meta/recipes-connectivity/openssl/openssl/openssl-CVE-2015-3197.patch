From b276250e7c987122a34e4bfa24fe08a7238d219a Mon Sep 17 00:00:00 2001
From: Viktor Dukhovni <openssl-users@dukhovni.org>
Date: Wed, 30 Dec 2015 22:44:51 -0500
Subject: [PATCH] Better SSLv2 cipher-suite enforcement

commit 4040a7fd104b412bd446338c6c28a62eb7d8e852 upstream
git://git.openssl.org/openssl.git

Based on patch by: Nimrod Aviram <nimrod.aviram@gmail.com>

CVE-2015-3197

Upstream Status: Backport
CVE: CVE-2015-3197

Reviewed-by: Tim Hudson <tjh@openssl.org>
Reviewed-by: Richard Levitte <levitte@openssl.org>
Signed-off-by: Zhang Xiao <xiao.zhang@windriver.com>
---
 ssl/s2_srvr.c | 15 +++++++++++++--
 1 file changed, 13 insertions(+), 2 deletions(-)

diff --git a/ssl/s2_srvr.c b/ssl/s2_srvr.c
index c5ffabc..e477244 100644
--- a/ssl/s2_srvr.c
+++ b/ssl/s2_srvr.c
@@ -393,7 +393,7 @@ static int get_client_master_key(SSL *s)
 			}
 
 		cp=ssl2_get_cipher_by_char(p);
-		if (cp == NULL)
+		if (cp == NULL || sk_SSL_CIPHER_find(s->session->ciphers, cp) < 0)
 			{
 			ssl2_return_error(s,SSL2_PE_NO_CIPHER);
 			SSLerr(SSL_F_GET_CLIENT_MASTER_KEY, SSL_R_NO_CIPHER_MATCH);
@@ -691,9 +691,13 @@ static int get_client_hello(SSL *s)
 		    prio = cs;
 		    allow = cl;
 		    }
+
+		/* Generate list of SSLv2 ciphers shared between client and server */
 		for (z=0; z<sk_SSL_CIPHER_num(prio); z++)
 			{
-			if (sk_SSL_CIPHER_find(allow,sk_SSL_CIPHER_value(prio,z)) < 0)
+			const SSL_CIPHER *cp = sk_SSL_CIPHER_value(prio, z);
+			if ((cp->algorithm_ssl & SSL_SSLV2) == 0 ||
+			    sk_SSL_CIPHER_find(allow, cp) < 0)
 				{
 				(void)sk_SSL_CIPHER_delete(prio,z);
 				z--;
@@ -704,6 +708,13 @@ static int get_client_hello(SSL *s)
 		    sk_SSL_CIPHER_free(s->session->ciphers);
 		    s->session->ciphers = prio;
 		    }
+
+		/* Make sure we have at least one cipher in common */
+		if (sk_SSL_CIPHER_num(s->session->ciphers) == 0) {
+		    ssl2_return_error(s, SSL2_PE_NO_CIPHER);
+		    SSLerr(SSL_F_GET_CLIENT_HELLO, SSL_R_NO_CIPHER_MATCH);
+		    return -1;
+		}
 		/* s->session->ciphers should now have a list of
 		 * ciphers that are on both the client and server.
 		 * This list is ordered by the order the client sent
-- 
1.9.1

